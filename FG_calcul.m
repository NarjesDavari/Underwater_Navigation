%Computation of the system matrix (F) and the system noise distribution
%matrix (G)
%dx_dot=Fdx+Gw
%dx=[dL dl dh dVn dVe dVd droll dpitch dyaw]T
%w=[dfx dfy dfz dwx dwy dwz]T
%Reference : My thesis page 88-89
%            Titterton page 344            
function [ F,G ] = FG_calcul( x,C )
    %x=[Lat;lon;d;Vn;Ve;Vd;fn;fe;fd]
    %C=body to navigation
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %Constant Parameters of the Earth
    R=6378137;%meter
    e=0.0818191908426;
    Omega=7.292115e-05;%Earth's rate, rad/s
    %gg=0000;%gg:Mass attraction of the Earth
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    M =R*(1-e^2)/(1-e^2*(sin(x(1)))^2)^1.5;%meridian radius of curvature
    N =R/(1-e^2*(sin(x(1)))^2)^0.5;%transverse radius of curvature
    R0=sqrt(M*N);%mean radius of the earth
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    F_pp=[0                                    ,0 ,-x(4)/(R0+x(3))^2
          x(5)*tan(x(1))/((R0+x(3))*cos(x(1))) ,0 ,-x(5)/((R0+x(3))^2*cos(x(1)))
          0                                    ,0 ,0                            ];    
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    F_pv=[1/(R0+x(3)) ,0                       ,0
          0           ,1/((R0+x(3))*cos(x(1))) ,0  
          0           ,0                       ,+1];
    % %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
    F_p_psi=[0 ,0 ,0
             0 ,0 ,0  
             0 ,0 ,0];
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%  
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    F_vp= [-x(5)*(2*Omega*cos(x(1))+x(5)/((R0+x(3))*cos(x(1))^2))                    ,0 ,(x(5)^2*tan(x(1))-x(4)*x(6))/(R0+x(3))^2
           2*Omega*(x(4)*cos(x(1))-x(6)*sin(x(1)))+x(4)*x(5)/((R0+x(3))*cos(x(1))^2) ,0 ,-x(5)*(x(4)*tan(x(1))+x(6))/(R0+x(3))^2
           2*Omega*x(5)*sin(x(1))                                                    ,0 ,(x(4)^2+x(5)^2)/(R0+x(3))^2 - 0 ];   %%        
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    F_vv = [x(6)/(R0+x(3))                            ,-2*Omega*sin(x(1))-2*x(5)*tan(x(1))/(R0+x(3)),x(4)/(R0+x(3))
            2*Omega*sin(x(1))+x(5)*tan(x(1))/(R0+x(3)),(x(6)+x(4)*tan(x(1)))/(R0+x(3))              ,2*Omega*cos(x(1))+x(5)/(R0+x(3))
            -2*x(4)/(R0+x(3))                         ,-2*Omega*cos(x(1))-2*x(5)/(R0+x(3))          ,0                               ];
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%   
    F_v_psi =[0    ,-x(9),x(8)
              x(9) ,0    ,-x(7)
              -x(8),x(7) ,0    ];
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    F_psi_p=[-Omega*sin(x(1))                             ,0 , -x(5)/((R0+x(3))^2)
             0                                            ,0 , x(4)/((R0+x(3))^2)
             -Omega*cos(x(1))-x(5)/((R0+x(3))*cos(x(1))^2),0 , tan(x(1))*x(5)/((R0+x(3))^2)];          
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    F_psi_v=[0             ,1/(R0+x(3))          ,0
             -1/(R0+x(3))  ,0                    ,0
             0             ,-tan(x(1))/(R0+x(3)) ,0];
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    F_psi_psi=[0                                       ,-x(5)*tan(x(1))/(R0+x(3))-Omega*sin(x(1)) ,x(4)/(R0+x(3))
               x(5)*tan(x(1))/(R0+x(3))+Omega*sin(x(1)),0                                         ,x(5)/(R0+x(3))+Omega*cos(x(1))
               -x(4)/(R0+x(3))                         ,-x(5)/(R0+x(3))-Omega*cos(x(1))           ,0                             ];

    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
   %******** with bias (Random walk)
   F_v_ba = C;
   F_psi_bg = -C;
     F=[F_pp   , F_pv   ,   F_p_psi ,   zeros(3)       , zeros(3)
          F_vp   , F_vv   ,   F_v_psi ,   F_v_ba  , zeros(3)   
          F_psi_p, F_psi_v,   F_psi_psi   zeros(3)      , F_psi_bg
          zeros(6,15)];%15x15
      
G=[zeros(3,12)
       C          , zeros(3,9)
       zeros(3)   , -C         , zeros(3,6)   
       zeros(3,6) , -eye(3)    , zeros(3)
       zeros(3,9) , -eye(3)];%15x12
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

end